import * as crypto from 'crypto';
import { utcToZonedTime, format } from 'date-fns-tz';

const NUM = '0123456789';

export function createMessageId() {
  const rnd = crypto.randomBytes(11);
  const value = new Array(11);
  const charsLength = NUM.length;

  for (let i = 0; i < value.length; i++) {
    if (i === 5) {
      value[5] = '-';
    } else {
      value[i] = NUM[rnd[i] % charsLength];
    }
  }

  return value.join('');
}

export function formatPhoneNumber(number) {
  const digits = number.replace(/\D/g, '');
  const split = digits.split('');
  const result = split.map((item, index) => {
    if (index === 0) return `(${item}`;
    if (index === 2) return `${item}) `;
    if (index === 5) return `${item}-`;
    else return item;
  });
  return result.join('');
}

export function createEmailTemplate({
  id,
  store,
  name,
  email,
  phone,
  message,
}) {
  const createdAt = new Date();
  const timeZone = 'America/Chicago';
  const zonedDate = utcToZonedTime(createdAt, timeZone);
  const date = format(zonedDate, 'MMMM do, yyyy - K:mmaaa', {
    timeZone: 'America/Chicago',
  });
  const strippedPhoneNumber = phone.replace(/\D/g, '');

  const text = `
  Contact Form Message \n
  \n
  Date: ${date} \n
  Message ID: ${id} \n
  Store: ${store} \n
  \n
  Name: ${name} \n
  Email: ${email} \n
  Phone: ${phone} \n
  \n
  Message: ${message} \n
  \n
  *This message was sent from the contact form at zabelmonuments.com
  `;

  const html = `<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" ><head><title>Zabel Monuments Contact Form Submission</title> <!--[if !mso]><!-- --><meta http-equiv="X-UA-Compatible" content="IE=edge" /> <!--<![endif]--><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><style type="text/css">#outlook a{padding:0}body{margin:0;padding:0;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}table,td{border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt}img{border:0;height:auto;line-height:100%;outline:none;text-decoration:none;-ms-interpolation-mode:bicubic}p{display:block;margin:13px 0}</style><!--[if mso]> <xml> <o:OfficeDocumentSettings> <o:AllowPNG /> <o:PixelsPerInch>96</o:PixelsPerInch> </o:OfficeDocumentSettings> </xml> <![endif]--> <!--[if lte mso 11]><style type="text/css">.mj-outlook-group-fix{width:100% !important}</style><![endif]--> <!--[if !mso]><!--><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet" type="text/css" /><style type="text/css">@import url(https://fonts.googleapis.com/css?family=Roboto:300,400,500,700);</style><!--<![endif]--><style type="text/css">@media only screen and (min-width: 480px){.mj-column-per-100{width:100% !important;max-width:100%}}</style><style type="text/css">@media only screen and (max-width: 480px){table.mj-full-width-mobile{width:100% !important}td.mj-full-width-mobile{width:auto !important}}</style></head><body style="background-color: #e5e7eb"><div style="background-color: #e5e7eb"> <!--[if mso | IE]><table align="center" border="0" cellpadding="0" cellspacing="0" class="" style="width:600px;" width="600" ><tr><td style="line-height:0px;font-size:0px;mso-line-height-rule:exactly;"> <![endif]--><div style="margin: 0px auto; max-width: 600px"><table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width: 100%" ><tbody><tr><td style=" direction: ltr; font-size: 0px; padding: 0 20px; text-align: center; " > <!--[if mso | IE]><table role="presentation" border="0" cellpadding="0" cellspacing="0"><tr><td class="" width="600px" ><table align="center" border="0" cellpadding="0" cellspacing="0" class="" style="width:560px;" width="560" ><tr><td style="line-height:0px;font-size:0px;mso-line-height-rule:exactly;"> <![endif]--><div style="margin: 0px auto; max-width: 560px"><table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width: 100%" ><tbody><tr><td style=" direction: ltr; font-size: 0px; padding: 20px 0; text-align: center; " > <!--[if mso | IE]><table role="presentation" border="0" cellpadding="0" cellspacing="0"><tr><td class="" style="vertical-align:top;width:560px;" > <![endif]--><div class="mj-column-per-100 mj-outlook-group-fix" style=" font-size: 0px; text-align: left; direction: ltr; display: inline-block; vertical-align: top; width: 100%; " ><table border="0" cellpadding="0" cellspacing="0" role="presentation" style="vertical-align: top" width="100%" ><tr><td align="center" style=" font-size: 0px; padding: 10px 25px; word-break: break-word; " ><table border="0" cellpadding="0" cellspacing="0" role="presentation" style=" border-collapse: collapse; border-spacing: 0px; " ><tbody><tr><td style="width: 175px"> <img alt="Zabel Monuments" height="auto" src="https://res.cloudinary.com/zabelmonuments/image/upload/v1632248094/zabel-monuments/website/logo-dark-text_wce5ge.png" style=" border: 0; display: block; outline: none; text-decoration: none; height: auto; width: 100%; font-size: 13px; " width="175" /></td></tr></tbody></table></td></tr></table></div> <!--[if mso | IE]></td></tr></table> <![endif]--></td></tr></tbody></table></div> <!--[if mso | IE]></td></tr></table></td></tr><tr><td class="" width="600px" ><table align="center" border="0" cellpadding="0" cellspacing="0" class="" style="width:560px;" width="560" ><tr><td style="line-height:0px;font-size:0px;mso-line-height-rule:exactly;"> <![endif]--><div style=" background: #ffffff; background-color: #ffffff; margin: 0px auto; border-radius: 2px; max-width: 560px; " ><table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style=" background: #ffffff; background-color: #ffffff; width: 100%; border-radius: 2px; " ><tbody><tr><td style=" direction: ltr; font-size: 0px; padding: 38px 0; text-align: center; " > <!--[if mso | IE]><table role="presentation" border="0" cellpadding="0" cellspacing="0"><tr><td class="" style="vertical-align:top;width:560px;" > <![endif]--><div class="mj-column-per-100 mj-outlook-group-fix" style=" font-size: 0px; text-align: left; direction: ltr; display: inline-block; vertical-align: top; width: 100%; " ><table border="0" cellpadding="0" cellspacing="0" role="presentation" style="vertical-align: top" width="100%" ><tr><td align="left" style=" font-size: 0px; padding: 0 35px; padding-bottom: 8px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 18px; font-weight: 500; line-height: 1; text-align: left; color: #111827; " > Contact Form Message</div></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1.6; text-align: left; color: #4b5563; " > ${date}</div></td></tr><tr><td style=" font-size: 0px; padding: 20px 40px 0; word-break: break-word; " ><p style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 100%; " ></p> <!--[if mso | IE]><table align="center" border="0" cellpadding="0" cellspacing="0" style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 480px; " role="presentation" width="480px" ><tr><td style="height: 0; line-height: 0"> &nbsp;</td></tr></table> <![endif]--></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; padding-top: 20px; padding-bottom: 6px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; font-weight: 600; line-height: 1; text-align: left; color: #111827; " > Store</div></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1.6; text-align: left; color: #4b5563; " > ${store}</div></td></tr><tr><td style=" font-size: 0px; padding: 20px 40px 0; word-break: break-word; " ><p style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 100%; " ></p> <!--[if mso | IE]><table align="center" border="0" cellpadding="0" cellspacing="0" style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 480px; " role="presentation" width="480px" ><tr><td style="height: 0; line-height: 0"> &nbsp;</td></tr></table> <![endif]--></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; padding-top: 20px; padding-bottom: 6px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; font-weight: 600; line-height: 1; text-align: left; color: #111827; " > Name</div></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1.6; text-align: left; color: #4b5563; " > ${name}</div></td></tr><tr><td style=" font-size: 0px; padding: 20px 40px 0; word-break: break-word; " ><p style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 100%; " ></p> <!--[if mso | IE]><table align="center" border="0" cellpadding="0" cellspacing="0" style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 480px; " role="presentation" width="480px" ><tr><td style="height: 0; line-height: 0"> &nbsp;</td></tr></table> <![endif]--></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; padding-top: 20px; padding-bottom: 6px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; font-weight: 600; line-height: 1; text-align: left; color: #111827; " > Email Address</div></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1.6; text-align: left; color: #4b5563; " > <a href="mailto:${email}" style=" color: #4b5563; text-decoration: none; " >${email}</a ></div></td></tr><tr><td style=" font-size: 0px; padding: 20px 40px 0; word-break: break-word; " ><p style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 100%; " ></p> <!--[if mso | IE]><table align="center" border="0" cellpadding="0" cellspacing="0" style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 480px; " role="presentation" width="480px" ><tr><td style="height: 0; line-height: 0"> &nbsp;</td></tr></table> <![endif]--></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; padding-top: 20px; padding-bottom: 6px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; font-weight: 600; line-height: 1; text-align: left; color: #111827; " > Phone Number</div></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1.6; text-align: left; color: #4b5563; " > <a href="tel:${strippedPhoneNumber}" style=" color: #4b5563; text-decoration: none; " >${phone}</a ></div></td></tr><tr><td style=" font-size: 0px; padding: 20px 40px 0; word-break: break-word; " ><p style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 100%; " ></p> <!--[if mso | IE]><table align="center" border="0" cellpadding="0" cellspacing="0" style=" border-top: solid 1px #e2e8f0; font-size: 1; margin: 0px auto; width: 480px; " role="presentation" width="480px" ><tr><td style="height: 0; line-height: 0"> &nbsp;</td></tr></table> <![endif]--></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; padding-top: 20px; padding-bottom: 6px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; font-weight: 600; line-height: 1; text-align: left; color: #111827; " > Message</div></td></tr><tr><td align="left" style=" font-size: 0px; padding: 0 35px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1.6; text-align: left; color: #4b5563; " > ${message}</div></td></tr></table></div> <!--[if mso | IE]></td></tr></table> <![endif]--></td></tr></tbody></table></div> <!--[if mso | IE]></td></tr></table></td></tr><tr><td class="" width="600px" ><table align="center" border="0" cellpadding="0" cellspacing="0" class="" style="width:560px;" width="560" ><tr><td style="line-height:0px;font-size:0px;mso-line-height-rule:exactly;"> <![endif]--><div style="margin: 0px auto; max-width: 560px"><table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width: 100%" ><tbody><tr><td style=" direction: ltr; font-size: 0px; padding: 20px 0; padding-top: 28px; text-align: center; " > <!--[if mso | IE]><table role="presentation" border="0" cellpadding="0" cellspacing="0"><tr><td class="" style="vertical-align:top;width:560px;" > <![endif]--><div class="mj-column-per-100 mj-outlook-group-fix" style=" font-size: 0px; text-align: left; direction: ltr; display: inline-block; vertical-align: top; width: 100%; " ><table border="0" cellpadding="0" cellspacing="0" role="presentation" style="vertical-align: top" width="100%" ><tr><td align="center" style=" font-size: 0px; padding: 10px 25px; word-break: break-word; " ><table border="0" cellpadding="0" cellspacing="0" role="presentation" style=" border-collapse: collapse; border-spacing: 0px; " ><tbody><tr><td style="width: 26px"> <img alt="Zabel Monuments" height="auto" src="https://res.cloudinary.com/zabelmonuments/image/upload/v1632245474/zabel-monuments/website/logo-small_xcwcej.png" style=" border: 0; display: block; outline: none; text-decoration: none; height: auto; width: 100%; font-size: 13px; " width="26" /></td></tr></tbody></table></td></tr><tr><td align="center" style=" font-size: 0px; padding: 8px 0 32px; word-break: break-word; " ><div style=" font-family: Roboto, sans-serif; font-size: 14px; line-height: 1; text-align: center; color: #4b5563; " > <a href="https://www.zabelmonuments.com" style=" color: #4b5563; text-decoration: none; letter-spacing: 0.4px; " >zabelmonuments.com</a ></div></td></tr></table></div> <!--[if mso | IE]></td></tr></table> <![endif]--></td></tr></tbody></table></div> <!--[if mso | IE]></td></tr></table></td></tr></table> <![endif]--></td></tr></tbody></table></div> <!--[if mso | IE]></td></tr></table> <![endif]--></div></body></html>`;

  return { html, text };
}
